<div class="bg-slate-800 rounded-xl p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="font-semibold text-xl">Mes Paris</h2>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <input type="date" id="dateFilter"
                    class="px-3 py-1.5 bg-slate-900/50 rounded-md text-sm border border-slate-700 focus:border-blue-500 outline-none">
                <select id="myBetsStatusFilter"
                    class="px-3 py-1.5 bg-slate-900/50 rounded-md text-sm border border-slate-700">
                    <option value="">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="won">Gagné (non payé)</option>
                    <option value="paid">Payé</option>
                    <option value="lost">Perdu</option>
                    <option value="cancelled">Annulé</option>
                </select>
                <input type="text" id="searchBetId" placeholder="Rechercher un ticket..."
                    class="px-3 py-1.5 bg-slate-900/50 rounded-md text-sm border border-slate-700 min-w-[200px]">
            </div>
            <button id="refreshMyBets"
                class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-md text-sm font-medium transition-colors">
                Rafraîchir
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-slate-900/50 rounded-lg p-4">
            <div class="text-sm text-slate-400">Total Misé</div>
            <div id="myTotalBetAmount" class="text-xl font-bold text-green-400 mt-1">0 HTG</div>
        </div>
        <div class="bg-slate-900/50 rounded-lg p-4">
            <div class="text-sm text-slate-400">Gains Potentiels</div>
            <div id="myPotentialWinnings" class="text-xl font-bold text-yellow-400 mt-1">0 HTG</div>
        </div>
        <div class="bg-slate-900/50 rounded-lg p-4">
            <div class="text-sm text-slate-400">En Attente Paiement</div>
            <div id="myPendingPayments" class="text-xl font-bold text-orange-400 mt-1">0 HTG</div>
        </div>
        <div class="bg-slate-900/50 rounded-lg p-4">
            <div class="text-sm text-slate-400">Gains Payés</div>
            <div id="myPaidWinnings" class="text-xl font-bold text-blue-400 mt-1">0 HTG</div>
        </div>
        <div class="bg-slate-900/50 rounded-lg p-4">
            <div class="text-sm text-slate-400">Taux de Réussite</div>
            <div id="myWinRate" class="text-xl font-bold text-purple-400 mt-1">0%</div>
        </div>
    </div>

    <!-- Table des tickets -->
    <section class="bg-slate-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Liste des tickets</h3>
            <div class="flex items-center gap-2">
                <input id="searchTicket" placeholder="Rechercher ID..."
                    class="px-3 py-1 rounded-md bg-slate-900/50 text-sm" />
                <select id="filterStatus" class="px-2 py-1 rounded-md bg-slate-900/50 text-sm">
                    <option value="">Tous</option>
                    <option value="pending">En attente</option>
                    <option value="won">Gagné</option>
                    <option value="lost">Perdu</option>
                    <option value="cancelled">Annulé</option>
                </select>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="text-slate-400 text-xs uppercase">
                    <tr>
                        <th class="p-2">ID</th>
                        <th class="p-2">Date</th>
                        <th class="p-2">Course</th>
                        <th class="p-2">Détails des paris</th>
                        <th class="p-2">Cote / Type</th>
                        <th class="p-2">Gain potentiel</th>
                        <th class="p-2">Statut</th>
                        <th class="p-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="ticketsTable" class="divide-y divide-slate-700">
                    <tr>
                        <td colspan="8" class="p-4 text-center text-slate-400">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Pagination -->
    <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-slate-400">
            Affichage <span id="displayedRange">0-0</span> sur <span id="totalMyBets">0</span> tickets
        </div>
        <div class="flex items-center gap-2">
            <button id="prevPage"
                class="px-3 py-1 bg-slate-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                Précédent
            </button>
            <span id="currentPage" class="px-3 py-1 bg-slate-900/50 rounded text-sm">Page 1</span>
            <button id="nextPage"
                class="px-3 py-1 bg-slate-700 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                Suivant
            </button>
        </div>
    </div>
</div>
<script>
(function(){
    // Utility to read user id if available (set by server or other script)
    const getUserId = () => {
        if (window.__USER_ID) return window.__USER_ID;
        if (document.body && document.body.dataset && document.body.dataset.userId) return document.body.dataset.userId;
        return null;
    };

    let currentPage = 1;
    const limit = 10;

    async function loadMyBets(page = 1) {
        const userId = getUserId();
        const params = new URLSearchParams();
        params.set('page', page);
        params.set('limit', limit);
        if (userId) params.set('user_id', userId);

        try {
            const res = await fetch('/api/v1/my-bets?' + params.toString());
            const json = await res.json();
            const payload = json && json.data ? json.data : json;
            if (!payload) return;

            // Update stats
            if (payload.stats) {
                const s = payload.stats;
                const format = v => (Number(v)||0).toFixed(2) + ' HTG';
                document.getElementById('myTotalBetAmount').textContent = format(s.totalBetAmount || s.totalBetAmount || 0);
                document.getElementById('myPotentialWinnings').textContent = format(s.potentialWinnings || 0);
                document.getElementById('myPendingPayments').textContent = format(s.pendingPayments || 0);
                document.getElementById('myPaidWinnings').textContent = format(s.paidWinnings || 0);
                document.getElementById('myWinRate').textContent = (s.winRate !== undefined ? s.winRate + '%' : '0%');
            }

            // Render tickets
            const tickets = payload.tickets || [];
            const tbody = document.getElementById('ticketsTable');
            tbody.innerHTML = '';
            if (tickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-400">Aucun ticket</td></tr>';
            } else {
                for (const t of tickets) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2">${t.id}</td>
                        <td class="p-2">${new Date(t.date).toLocaleString()}</td>
                        <td class="p-2">${t.roundId || '-'}</td>
                        <td class="p-2">${(t.bets || []).map(b=>`#${b.number} ${b.participant?.name||''} (${(Number(b.value)||0).toFixed(2)} HTG)`).join('<br/>')}</td>
                        <td class="p-2">${t.avgCoeff || (t.isMultibet ? 'Multi' : '-')}</td>
                        <td class="p-2">${(Number(t.potentialWinnings)||0).toFixed(2)} HTG</td>
                        <td class="p-2">${t.status || '-'}</td>
                        <td class="p-2">${t.status === 'won' ? `<button data-id="${t.id}" class="payBtn px-2 py-1 bg-green-600 text-white rounded text-xs">Payer</button>` : ''} <a href="/pages/my-bets.html?id=${t.id}" class="px-2 py-1 bg-slate-700 text-white rounded text-xs">Voir</a></td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            // Pagination
            if (payload.pagination) {
                const p = payload.pagination;
                document.getElementById('displayedRange').textContent = p.displayedRange || `${(p.currentPage-1)*p.limit+1}-${(p.currentPage-1)*p.limit + (payload.tickets||[]).length}`;
                document.getElementById('totalMyBets').textContent = p.totalItems || 0;
                document.getElementById('currentPage').textContent = 'Page ' + (p.currentPage || 1);
                // enable/disable prev/next
                document.getElementById('prevPage').disabled = (p.currentPage || 1) <= 1;
                document.getElementById('nextPage').disabled = (p.currentPage || 1) >= (p.totalPages || 1);
            }

            // Attach pay handlers
            document.querySelectorAll('.payBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.dataset.id;
                    if (!confirm('Marquer le ticket #' + id + ' comme payé ?')) return;
                    try {
                        const resp = await fetch('/api/v1/my-bets/pay/' + encodeURIComponent(id), { method: 'POST' });
                        const j = await resp.json();
                        if (j && (j.data || j.success || j.success === undefined)) {
                            // refresh
                            loadMyBets(currentPage);
                        }
                    } catch (err) {
                        console.error('Erreur pay:', err);
                        alert('Erreur lors du paiement');
                    }
                });
            });

        } catch (err) {
            console.error('Erreur loadMyBets:', err);
        }
    }

    // Controls
    document.getElementById('refreshMyBets').addEventListener('click', () => { currentPage = 1; loadMyBets(1); });
    document.getElementById('prevPage').addEventListener('click', () => { if (currentPage>1) { currentPage--; loadMyBets(currentPage); } });
    document.getElementById('nextPage').addEventListener('click', () => { currentPage++; loadMyBets(currentPage); });

    // simple search/filter triggers
    document.getElementById('searchTicket').addEventListener('input', (e)=>{ /* could wire server-side search later */ });
    document.getElementById('filterStatus').addEventListener('change', ()=>{ loadMyBets(1); });

    // initial load
    loadMyBets(currentPage);

})();
</script>
